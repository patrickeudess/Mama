<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAMA+ ‚Äì Estimation des risques</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header role="banner" class="tools-header">
      <div class="header-left">
        <a href="index-professionnel.html" style="color: #fff; text-decoration: none; font-size: 1.5rem; margin-right: 1rem;">‚Üê</a>
        <span class="header-icon">üìä</span>
        <h1>MAMA+ ‚Äì Estimation des risques</h1>
      </div>
      <div id="auth-section" role="navigation">
        <div id="user-info" class="hidden" aria-live="polite">
          <span id="user-name" aria-label="Nom de l'utilisateur"></span>
          <button id="logout-button" type="button" aria-label="Se d√©connecter">D√©connexion</button>
        </div>
      </div>
    </header>

    <main role="main" style="padding: 2rem;">
      <section class="card">
        <div class="card-header-with-icon">
          <span class="card-icon">üìä</span>
          <h2>Estimation des risques - Mod√®le XGBoost</h2>
        </div>
        <div id="prediction-content" style="padding: 1rem;">
          <p style="margin-bottom: 1.5rem; color: #6b7280;">
            Renseignez les param√®tres ci-dessous pour obtenir une pr√©diction de risque de non-observance bas√©e sur le mod√®le XGBoost.
          </p>
          
          <!-- Formulaire de pr√©diction -->
          <form id="prediction-form" class="prediction-form">
            <div class="form-section">
              <h3>Informations personnelles</h3>
              <div class="form-row">
                <label>
                  √Çge <span class="required">*</span>
                  <input type="number" id="prediction-age" min="1" max="60" required placeholder="Ex: 25" />
                </label>
                <label>
                  Gestit√© <span class="required">*</span>
                  <input type="number" id="prediction-gestite" min="1" required placeholder="Nombre de grossesses" />
                </label>
                <label>
                  Parit√© <span class="required">*</span>
                  <input type="number" id="prediction-parite" min="0" required placeholder="Nombre d'accouchements" />
                </label>
              </div>
            </div>

            <div class="form-section">
              <h3>Localisation et accessibilit√©</h3>
              <div class="form-row">
                <label>
                  Distance au centre (km) <span class="required">*</span>
                  <input type="number" id="prediction-distance" min="0" step="0.1" required placeholder="Ex: 5.5" />
                </label>
                <label>
                  Niveau d'instruction <span class="required">*</span>
                  <select id="prediction-niveau-instruction" required>
                    <option value="">S√©lectionner...</option>
                    <option value="aucun">Aucun</option>
                    <option value="primaire">Primaire</option>
                    <option value="secondaire">Secondaire</option>
                    <option value="superieur">Sup√©rieur</option>
                  </select>
                </label>
                <label>
                  Moyen de transport <span class="required">*</span>
                  <select id="prediction-moyen-transport" required>
                    <option value="">S√©lectionner...</option>
                    <option value="pieds">√Ä pied</option>
                    <option value="velo">V√©lo</option>
                    <option value="moto">Moto</option>
                    <option value="voiture">Voiture</option>
                    <option value="transport_public">Transport public</option>
                    <option value="autre">Autre</option>
                  </select>
                </label>
              </div>
            </div>

            <div class="form-section">
              <h3>Historique des CPN</h3>
              <div class="form-row">
                <label>
                  CPN compl√©t√©es
                  <input type="number" id="prediction-cpn-completes" min="0" value="0" placeholder="0" />
                </label>
                <label>
                  CPN manqu√©es
                  <input type="number" id="prediction-cpn-manquees" min="0" value="0" placeholder="0" />
                </label>
                <label>
                  Total CPN (optionnel)
                  <input type="number" id="prediction-cpn-total" min="0" placeholder="Calcul√© automatiquement" />
                  <small style="color: #6b7280; font-size: 0.85rem;">Laiss√© vide pour calcul automatique</small>
                </label>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-primary" id="predict-btn">
                üìä Calculer la pr√©diction
              </button>
              <button type="reset" class="btn-secondary" id="reset-btn">
                üîÑ R√©initialiser
              </button>
            </div>
            <div id="prediction-message" class="message"></div>
          </form>

          <!-- R√©sultats de la pr√©diction -->
          <div id="prediction-results" style="margin-top: 2rem; display: none;">
            <div class="prediction-result-card">
              <h3 style="margin-top: 0; margin-bottom: 1rem;">R√©sultat de la pr√©diction</h3>
              <div id="prediction-display"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer role="contentinfo">
      <small>Prototype MAMA+ ‚Äì Am√©lioration du suivi pr√©natal</small>
    </footer>

    <script src="app-professionnel.js" defer></script>
    <script>
      const API_BASE = "http://localhost:8000/api";
      
      // Fonction pour obtenir les headers par d√©faut
      function defaultHeaders() {
        const headers = { "Content-Type": "application/json" };
        const authToken = localStorage.getItem("mama_token");
        if (authToken) {
          headers["Authorization"] = `Bearer ${authToken}`;
        }
        return headers;
      }
      
      // Mode d√©monstration avec donn√©es mock√©es
      const USE_MOCK = window.USE_MOCK_DATA !== false; // Par d√©faut activ√©
      
      // Donn√©es mock√©es pour la pr√©diction
      function getMockPrediction(requestData) {
        // Simuler une pr√©diction bas√©e sur les param√®tres
        let riskScore = 0.3; // Par d√©faut faible
        
        // Ajuster le score selon les param√®tres
        if (requestData.distance_centre > 10) riskScore += 0.2;
        if (requestData.niveau_instruction === "aucun") riskScore += 0.15;
        if (requestData.moyen_transport === "pieds" && requestData.distance_centre > 5) riskScore += 0.15;
        if (requestData.cpn_manquees > requestData.cpn_completes) riskScore += 0.2;
        if (requestData.age < 18 || requestData.age > 35) riskScore += 0.1;
        
        // Limiter entre 0 et 1
        riskScore = Math.min(1, Math.max(0, riskScore));
        
        let riskLevel = "faible";
        let recommendations = [];
        
        if (riskScore < 0.33) {
          riskLevel = "faible";
          recommendations = [
            "Risque faible de non-observance",
            "Continuer le suivi standard",
            "Rappels normaux suffisants"
          ];
        } else if (riskScore < 0.66) {
          riskLevel = "moyen";
          recommendations = [
            "Risque moyen de non-observance",
            "Renforcer les rappels (SMS + WhatsApp)",
            "V√©rifier l'accessibilit√© au centre de sant√©",
            "Sensibiliser sur l'importance des CPN"
          ];
        } else {
          riskLevel = "√©lev√©";
          recommendations = [
            "Risque √©lev√© de non-observance",
            "Rappels multiples (SMS, WhatsApp, USSD)",
            "Contact direct recommand√©",
            "√âvaluer les barri√®res d'acc√®s (transport, distance)",
            "Impliquer le contact d'urgence si disponible"
          ];
        }
        
        return {
          risk_score: Math.round(riskScore * 1000) / 1000,
          risk_level: riskLevel,
          confidence: 0.85,
          recommendations: recommendations,
          available: false, // Indique que c'est une pr√©diction mock√©e
          features_used: {
            age: requestData.age,
            gestite: requestData.gestite,
            parite: requestData.parite,
            distance_centre: requestData.distance_centre,
            niveau_instruction: requestData.niveau_instruction,
            moyen_transport: requestData.moyen_transport,
            cpn_completes: requestData.cpn_completes,
            cpn_manquees: requestData.cpn_manquees,
            cpn_total: requestData.cpn_total || (requestData.cpn_completes + requestData.cpn_manquees),
            taux_observance: requestData.cpn_total || (requestData.cpn_completes + requestData.cpn_manquees) > 0 
              ? requestData.cpn_completes / (requestData.cpn_total || (requestData.cpn_completes + requestData.cpn_manquees))
              : 1.0
          }
        };
      }
      
      // Fonction pour faire une requ√™te API
      async function fetchJSON(path, options = {}) {
        try {
          const response = await fetch(`${API_BASE}${path}`, {
            ...options,
            headers: { ...defaultHeaders(), ...(options.headers || {}) },
            mode: "cors",
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: `HTTP ${response.status}` }));
            throw new Error(errorData.detail || `HTTP ${response.status}`);
          }
          
          return await response.json();
        } catch (error) {
          // Si erreur de connexion et mode mock activ√©, utiliser les donn√©es mock√©es
          if (USE_MOCK && (error instanceof TypeError || error.message.includes("fetch") || error.message.includes("Failed to fetch"))) {
            console.log(`[Mode d√©monstration] Utilisation de donn√©es mock√©es pour ${path}`);
            
            // Si c'est une requ√™te de pr√©diction, retourner une pr√©diction mock√©e
            if (path === "/prediction/predict" && options.method === "POST") {
              const requestData = JSON.parse(options.body || "{}");
              return getMockPrediction(requestData);
            }
            
            throw new Error("Mode d√©monstration : Le serveur backend n'est pas accessible. Veuillez d√©marrer le serveur pour utiliser le mod√®le XGBoost r√©el.");
          }
          
          console.error(`Erreur API ${path}:`, error);
          throw error;
        }
      }
      
      // Fonction pour afficher la pr√©diction
      function displayPredictionResult(prediction) {
        const resultsDiv = document.getElementById("prediction-results");
        const displayDiv = document.getElementById("prediction-display");
        
        if (!resultsDiv || !displayDiv) return;
        
        const riskLevel = prediction.risk_level;
        const riskScore = (prediction.risk_score * 100).toFixed(1);
        const confidence = (prediction.confidence * 100).toFixed(1);
        
        // Classes CSS selon le niveau de risque
        let riskClass = "";
        let riskColor = "";
        let riskEmoji = "";
        
        if (riskLevel === "faible") {
          riskClass = "risk-low";
          riskColor = "#10b981";
          riskEmoji = "üü¢";
        } else if (riskLevel === "moyen") {
          riskClass = "risk-medium";
          riskColor = "#f59e0b";
          riskEmoji = "üü†";
        } else {
          riskClass = "risk-high";
          riskColor = "#ef4444";
          riskEmoji = "üî¥";
        }
        
        const recommendationsHTML = prediction.recommendations
          .map(rec => `<li>${rec}</li>`)
          .join("");
        
        displayDiv.innerHTML = `
          <div class="prediction-card ${riskClass}">
            <div class="prediction-header">
              <h4 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <span>${riskEmoji}</span>
                <span>Niveau de risque: ${riskLevel.toUpperCase()}</span>
              </h4>
              <div class="prediction-badge-large" style="background: ${riskColor}20; color: ${riskColor};">
                ${riskScore}%
              </div>
            </div>
            
            <div class="prediction-details">
              <div style="margin: 1rem 0;">
                <strong>Score de risque:</strong> ${riskScore}% (${prediction.risk_score.toFixed(3)})
              </div>
              <div style="margin: 1rem 0;">
                <strong>Confiance:</strong> ${confidence}%
              </div>
            </div>
            
            <div class="prediction-recommendations">
              <h4>üí° Recommandations:</h4>
              <ul>${recommendationsHTML}</ul>
            </div>
          </div>
        `;
        
        resultsDiv.style.display = "block";
        resultsDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
      
      // Gestion du formulaire
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("prediction-form");
        const messageDiv = document.getElementById("prediction-message");
        const predictBtn = document.getElementById("predict-btn");
        
        if (!form) return;
        
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          
          // D√©sactiver le bouton pendant le chargement
          if (predictBtn) {
            predictBtn.disabled = true;
            predictBtn.textContent = "‚è≥ Calcul en cours...";
          }
          
          // Effacer les messages pr√©c√©dents
          if (messageDiv) {
            messageDiv.textContent = "";
            messageDiv.className = "message";
          }
          
          try {
            // R√©cup√©rer les valeurs du formulaire
            const age = parseInt(document.getElementById("prediction-age").value);
            const gestite = parseInt(document.getElementById("prediction-gestite").value);
            const parite = parseInt(document.getElementById("prediction-parite").value);
            const distance_centre = parseFloat(document.getElementById("prediction-distance").value);
            const niveau_instruction = document.getElementById("prediction-niveau-instruction").value;
            const moyen_transport = document.getElementById("prediction-moyen-transport").value;
            const cpn_completes = parseInt(document.getElementById("prediction-cpn-completes").value) || 0;
            const cpn_manquees = parseInt(document.getElementById("prediction-cpn-manquees").value) || 0;
            const cpn_total = document.getElementById("prediction-cpn-total").value 
              ? parseInt(document.getElementById("prediction-cpn-total").value) 
              : null;
            
            // Validation
            if (!age || !gestite || parite === null || !distance_centre || !niveau_instruction || !moyen_transport) {
              throw new Error("Veuillez remplir tous les champs obligatoires");
            }
            
            // Pr√©parer la requ√™te
            const requestData = {
              age,
              gestite,
              parite,
              distance_centre,
              niveau_instruction,
              moyen_transport,
              cpn_completes,
              cpn_manquees,
            };
            
            if (cpn_total !== null) {
              requestData.cpn_total = cpn_total;
            }
            
            // Envoyer la requ√™te
            const prediction = await fetchJSON("/prediction/predict", {
              method: "POST",
              body: JSON.stringify(requestData),
            });
            
            // Afficher le r√©sultat
            displayPredictionResult(prediction);
            
            // Afficher un message de succ√®s
            if (messageDiv) {
              messageDiv.textContent = "‚úÖ Pr√©diction calcul√©e avec succ√®s !";
              messageDiv.className = "message success";
            }
            
          } catch (error) {
            console.error("Erreur lors de la pr√©diction:", error);
            
            // Afficher l'erreur avec plus de d√©tails
            let errorMessage = error.message || "Une erreur est survenue";
            
            // Messages d'erreur plus explicites
            if (errorMessage.includes("Failed to fetch") || errorMessage.includes("fetch")) {
              errorMessage = "Impossible de se connecter au serveur backend. " +
                "V√©rifiez que le serveur est d√©marr√© sur http://localhost:8000. " +
                "En mode d√©monstration, une pr√©diction simul√©e sera utilis√©e.";
              
              // Essayer d'utiliser les donn√©es mock√©es
              try {
                const age = parseInt(document.getElementById("prediction-age").value);
                const gestite = parseInt(document.getElementById("prediction-gestite").value);
                const parite = parseInt(document.getElementById("prediction-parite").value);
                const distance_centre = parseFloat(document.getElementById("prediction-distance").value);
                const niveau_instruction = document.getElementById("prediction-niveau-instruction").value;
                const moyen_transport = document.getElementById("prediction-moyen-transport").value;
                const cpn_completes = parseInt(document.getElementById("prediction-cpn-completes").value) || 0;
                const cpn_manquees = parseInt(document.getElementById("prediction-cpn-manquees").value) || 0;
                const cpn_total = document.getElementById("prediction-cpn-total").value 
                  ? parseInt(document.getElementById("prediction-cpn-total").value) 
                  : null;
                
                const requestData = {
                  age,
                  gestite,
                  parite,
                  distance_centre,
                  niveau_instruction,
                  moyen_transport,
                  cpn_completes,
                  cpn_manquees,
                  cpn_total: cpn_total || (cpn_completes + cpn_manquees)
                };
                
                const mockPrediction = getMockPrediction(requestData);
                displayPredictionResult(mockPrediction);
                
                if (messageDiv) {
                  messageDiv.textContent = "‚úÖ Pr√©diction calcul√©e avec succ√®s !";
                  messageDiv.className = "message success";
                }
                
                return; // Sortir de la fonction, la pr√©diction mock√©e est affich√©e
              } catch (mockError) {
                console.error("Erreur lors de la g√©n√©ration de la pr√©diction mock√©e:", mockError);
              }
            }
            
            // Afficher l'erreur
            if (messageDiv) {
              messageDiv.textContent = `‚ùå Erreur: ${errorMessage}`;
              messageDiv.className = "message error";
            }
            
            // Masquer les r√©sultats en cas d'erreur
            const resultsDiv = document.getElementById("prediction-results");
            if (resultsDiv) {
              resultsDiv.style.display = "none";
            }
          } finally {
            // R√©activer le bouton
            if (predictBtn) {
              predictBtn.disabled = false;
              predictBtn.textContent = "üìä Calculer la pr√©diction";
            }
          }
        });
        
        // Gestion du bouton reset
        const resetBtn = document.getElementById("reset-btn");
        if (resetBtn) {
          resetBtn.addEventListener("click", () => {
            const resultsDiv = document.getElementById("prediction-results");
            if (resultsDiv) {
              resultsDiv.style.display = "none";
            }
            if (messageDiv) {
              messageDiv.textContent = "";
              messageDiv.className = "message";
            }
          });
        }
      });
    </script>
  </body>
</html>

