<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <title>MAMA+ ‚Äì Mes patientes</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="styles-ux.css" />
    <link rel="stylesheet" href="styles-icons.css" />
    <link rel="stylesheet" href="styles-mobile-nav.css" />
  </head>
  <body>
    <header role="banner" class="tools-header">
      <div class="header-left">
        <a href="#" style="color: #fff; text-decoration: none; font-size: 1.5rem; margin-right: 1rem; display: inline-flex; align-items: center;" id="back-icon-link" onclick="goBack(); return false;"></a>
        <span class="header-icon" id="header-patientes-icon"></span>
        <h1>MAMA+ ‚Äì Mes patientes</h1>
      </div>
      <div id="auth-section" role="navigation">
        <div id="user-info" class="hidden" aria-live="polite">
          <span id="user-name" aria-label="Nom de l'utilisateur"></span>
          <button id="logout-button" type="button" aria-label="Se d√©connecter">D√©connexion</button>
        </div>
      </div>
    </header>

    <main role="main" style="padding: 2rem;">
      <div class="card" id="patients-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2 style="margin: 0;">Patientes suivies</h2>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button id="add-patiente-btn-section" type="button" class="btn-primary" aria-label="Ouvrir le formulaire pour ajouter une nouvelle patiente">+ Ajouter une patiente</button>
          </div>
        </div>
        
        <!-- Recherche en temps r√©el -->
        <div class="search-container" style="margin-bottom: 1rem;">
          <input 
            type="text" 
            id="search-input" 
            class="search-input" 
            placeholder="Rechercher une patiente (nom, ville, t√©l√©phone...)"
            aria-label="Rechercher une patiente"
          />
          <span class="search-icon" id="search-icon-placeholder"></span>
          <div class="search-results-count" id="search-results-count" style="display: none;"></div>
        </div>
        
        <!-- Tri personnalisable -->
        <div class="sort-container" style="margin-bottom: 1rem;">
          <span class="sort-label">Trier par:</span>
          <select id="sort-select" class="sort-select" aria-label="Trier les patientes">
            <option value="nom-asc">Nom (A-Z)</option>
            <option value="nom-desc">Nom (Z-A)</option>
            <option value="age-asc">√Çge (croissant)</option>
            <option value="age-desc">√Çge (d√©croissant)</option>
            <option value="distance-asc">Distance (proche)</option>
            <option value="distance-desc">Distance (loin)</option>
            <option value="risque">Risque (√©lev√© ‚Üí faible)</option>
            <option value="derniere-venue">Derni√®re venue (r√©cent)</option>
          </select>
        </div>
        
        <div class="table-controls-advanced">
          <div class="filters-row">
            <label>
              Risque:
              <select id="risk-filter">
                <option value="all">Tous</option>
                <option value="√©lev√©">üî¥ √âlev√©</option>
                <option value="moyen">üü† Mod√©r√©</option>
                <option value="faible">üü¢ Faible</option>
              </select>
            </label>
            <label>
              Localit√©:
              <select id="location-filter">
                <option value="all">Toutes</option>
              </select>
            </label>
            <label>
              Semaine grossesse:
              <select id="week-filter">
                <option value="all">Toutes</option>
                <option value="0-12">0-12 semaines</option>
                <option value="13-24">13-24 semaines</option>
                <option value="25-36">25-36 semaines</option>
                <option value="37-42">37-42 semaines</option>
              </select>
            </label>
            <label>
              Statut CPN:
              <select id="cpn-status-filter">
                <option value="all">Tous</option>
                <option value="complete">Compl√©t√©es</option>
                <option value="manque">Manqu√©es</option>
                <option value="planifie">Planifi√©es</option>
              </select>
            </label>
            <label>
              √Çge:
              <select id="age-filter">
                <option value="all">Tous</option>
                <option value="15-20">15-20 ans</option>
                <option value="21-25">21-25 ans</option>
                <option value="26-30">26-30 ans</option>
                <option value="31-35">31-35 ans</option>
                <option value="36-40">36-40 ans</option>
                <option value="41+">41 ans et plus</option>
              </select>
            </label>
            <label>
              Distance:
              <select id="distance-filter">
                <option value="all">Toutes</option>
                <option value="0-2">0-2 km</option>
                <option value="2-5">2-5 km</option>
                <option value="5-10">5-10 km</option>
                <option value="10+">Plus de 10 km</option>
              </select>
            </label>
            <label>
              Derni√®re venue:
              <select id="last-visit-filter">
                <option value="all">Toutes</option>
                <option value="today">Aujourd'hui</option>
                <option value="week">Cette semaine</option>
                <option value="month">Ce mois</option>
                <option value="3months">3 derniers mois</option>
                <option value="never">Jamais</option>
              </select>
            </label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
              <button id="reset-filters-btn" type="button" class="btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">üîÑ R√©initialiser</button>
              <button id="export-btn" type="button" class="btn-secondary">üìä Exporter</button>
            </div>
          </div>
        </div>
        <div class="table-container">
          <table id="patient-table" role="table" aria-label="Liste des patientes suivies">
            <thead>
              <tr>
                <th scope="col">Nom</th>
                <th scope="col">√Çge</th>
                <th scope="col">Distance</th>
                <th scope="col">Risque</th>
                <th scope="col">Derni√®re venue</th>
                <th scope="col">Prochaine CPN</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody role="rowgroup"></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Modal pour ajouter une patiente -->
    <div id="add-patiente-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Ajouter une nouvelle patiente</h2>
          <button id="close-modal-btn" type="button" class="close-btn" aria-label="Fermer">&times;</button>
        </div>
        <form id="add-patiente-form">
          <div class="form-section">
            <h3>Pour se connecter</h3>
            <label>
              Num√©ro d'identification <span class="required">*</span>
              <input type="number" id="patiente-id" placeholder="Exemple: 1001" min="1" required />
              <small style="color: #6b7280; font-size: 0.875rem;">Un num√©ro unique pour identifier la patiente. C'est obligatoire.</small>
            </label>
            <label>
              Num√©ro de t√©l√©phone <span class="required">*</span>
              <input type="tel" id="patiente-telephone" placeholder="Exemple: +2250700000000" required />
            </label>
            <label>
              Mot de passe <span class="required">*</span>
              <input type="password" id="patiente-password" minlength="6" placeholder="Au moins 6 lettres ou chiffres" required />
            </label>
          </div>

          <div class="form-section">
            <h3>Vos informations</h3>
            <div class="form-row">
              <label>
                Pr√©nom
                <input type="text" id="patiente-prenom" placeholder="Votre pr√©nom" />
              </label>
              <label>
                Nom
                <input type="text" id="patiente-nom" placeholder="Votre nom" />
              </label>
            </div>
            <label>
              √Çge <span class="required">*</span>
              <input type="number" id="patiente-age" min="1" max="60" placeholder="Votre √¢ge" required />
            </label>
            <div class="form-row">
              <label>
                Nombre de grossesses
                <input type="number" id="patiente-gestite" min="1" value="1" placeholder="Combien de fois vous √™tes tomb√©e enceinte" />
                <small style="color: #6b7280; font-size: 0.875rem;">Y compris cette grossesse</small>
              </label>
              <label>
                Nombre d'enfants n√©s
                <input type="number" id="patiente-parite" min="0" value="0" placeholder="Combien d'enfants vous avez d√©j√† eus" />
              </label>
            </div>
            <label>
              Niveau d'√©tudes
              <select id="patiente-niveau-instruction">
                <option value="">Choisir...</option>
                <option value="aucun">Pas d'√©cole</option>
                <option value="primaire">√âcole primaire</option>
                <option value="secondaire">√âcole secondaire</option>
                <option value="superieur">√âtudes sup√©rieures</option>
              </select>
            </label>
            <label>
              Langue que vous parlez le mieux
              <select id="patiente-langue">
                <option value="fr">Fran√ßais</option>
                <option value="bambara">Bambara</option>
                <option value="wolof">Wolof</option>
              </select>
            </label>
          </div>

          <div class="form-section">
            <h3>O√π vous habitez</h3>
            <label>
              Pays <span class="required">*</span>
              <select id="patiente-pays" required>
                <option value="">Choisir un pays...</option>
                <option value="C√¥te d'Ivoire" selected>C√¥te d'Ivoire</option>
                <option value="Mali">Mali</option>
                <option value="Burkina Faso">Burkina Faso</option>
                <option value="S√©n√©gal">S√©n√©gal</option>
                <option value="Guin√©e">Guin√©e</option>
                <option value="Niger">Niger</option>
                <option value="B√©nin">B√©nin</option>
                <option value="Togo">Togo</option>
                <option value="Ghana">Ghana</option>
              </select>
            </label>
            <label>
              Ville <span class="required">*</span>
              <select id="patiente-ville" required>
                <option value="">Choisir une ville...</option>
                <!-- Les options seront remplies dynamiquement selon le pays s√©lectionn√© -->
              </select>
              <small style="color: #6b7280; font-size: 0.875rem;">S√©lectionnez d'abord le pays pour voir les villes disponibles</small>
            </label>
            <label>
              Centre de sant√© <span class="required">*</span>
              <select id="patiente-centre-sante" required>
                <option value="">Choisir un centre de sant√©...</option>
                <!-- Les options seront remplies dynamiquement selon la ville s√©lectionn√©e -->
              </select>
              <small style="color: #6b7280; font-size: 0.875rem;">S√©lectionnez d'abord la ville pour voir les centres disponibles</small>
            </label>
            <label>
              Adresse
              <input type="text" id="patiente-adresse" placeholder="Quartier, rue, num√©ro" />
            </label>
            <div class="form-row">
              <label>
                Distance du centre de sant√© (en kilom√®tres)
                <input type="number" id="patiente-distance" step="0.1" min="0" placeholder="Exemple: 2.5" />
              </label>
              <label>
                Comment vous vous d√©placez
                <select id="patiente-transport">
                  <option value="">Choisir...</option>
                  <option value="pieds">√Ä pied</option>
                  <option value="velo">√Ä v√©lo</option>
                  <option value="moto">En moto</option>
                  <option value="voiture">En voiture</option>
                  <option value="transport_public">Bus ou taxi</option>
                </select>
              </label>
            </div>
          </div>

          <div class="form-section">
            <h3>P√©riode de suivi</h3>
            <label>
              P√©riode de suivi <span class="required">*</span>
              <select id="patiente-periode" required>
                <option value="">Choisir une p√©riode...</option>
                <option value="week">Semaine</option>
                <option value="month" selected>Mois</option>
                <option value="quarter">Trimestre</option>
                <option value="year">Ann√©e</option>
              </select>
              <small style="color: #6b7280; font-size: 0.875rem;">P√©riode de suivi pr√©natal de la patiente</small>
            </label>
          </div>

          <div class="form-section">
            <h3>G√©n√©ration automatique des CPN</h3>
            <label>
              Date de 1√®re CPN
              <input type="date" id="patiente-premiere-cpn" />
              <small style="color: #6b7280; font-size: 0.875rem;">Date de la premi√®re consultation pr√©natale (CPN1)</small>
            </label>
            <label>
              Semaine de grossesse (au moment de la 1√®re CPN)
              <input type="number" id="patiente-semaine-grossesse" min="1" max="42" placeholder="Ex: 12" />
              <small style="color: #6b7280; font-size: 0.875rem;">Semaine de grossesse au moment de la CPN1 (pour calculer les suivantes)</small>
            </label>
            <label>
              Nombre de CPN √† g√©n√©rer
              <select id="patiente-nombre-cpn">
                <option value="4" selected>4 CPN (standard)</option>
                <option value="8">8 CPN (suivi complet)</option>
              </select>
              <small style="color: #6b7280; font-size: 0.875rem;">Le syst√®me g√©n√©rera automatiquement les prochaines consultations</small>
            </label>
            <div id="cpn-preview" style="margin-top: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; display: none;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #374151;">Aper√ßu des CPN √† g√©n√©rer :</p>
              <div id="cpn-preview-list" style="font-size: 0.875rem; color: #6b7280;"></div>
            </div>
          </div>

          <div class="form-section">
            <h3>Lien professionnel</h3>
            <label>
              Centre / Professionnel r√©f√©rent
              <input type="text" id="patiente-pro-referent" placeholder="Nom du centre ou professionnel r√©f√©rent" />
              <small style="color: #6b7280; font-size: 0.875rem;">Laissez vide si la patiente n'a pas encore de r√©f√©rent</small>
            </label>
          </div>

          <div class="form-section">
            <h3>Votre sant√©</h3>
            <label>
              Date de vos derni√®res r√®gles
              <input type="date" id="patiente-dernieres-regles" />
              <small style="color: #6b7280; font-size: 0.875rem;">Le premier jour de vos derni√®res r√®gles</small>
            </label>
            <label>
              Date pr√©vue pour l'accouchement
              <input type="date" id="patiente-accouchement-prevue" />
            </label>
            <label>
              Maladies pass√©es ou actuelles
              <textarea id="patiente-antecedents-medicaux" rows="3" placeholder="√âcrivez les maladies que vous avez eues ou avez actuellement"></textarea>
            </label>
            <label>
              Probl√®mes lors des grossesses pass√©es
              <textarea id="patiente-antecedents-obstetricaux" rows="3" placeholder="√âcrivez s'il y a eu des probl√®mes lors de vos grossesses pr√©c√©dentes"></textarea>
            </label>
            <label>
              Allergies
              <textarea id="patiente-allergies" rows="2" placeholder="√âcrivez les choses auxquelles vous √™tes allergique"></textarea>
            </label>
          </div>

          <div class="form-section">
            <h3>Personne √† appeler en cas de probl√®me</h3>
            <label>
              Nom de la personne
              <input type="text" id="patiente-contact-nom" placeholder="Nom de la personne √† contacter" />
            </label>
            <label>
              Num√©ro de t√©l√©phone d'urgence
              <input type="tel" id="patiente-contact-telephone" placeholder="Num√©ro √† appeler en cas d'urgence" />
            </label>
          </div>

          <div class="form-actions">
            <button type="button" id="cancel-patiente-btn" class="btn-secondary">Annuler</button>
            <button type="submit" class="btn-primary">Enregistrer la patiente</button>
          </div>
          <div id="patiente-message" class="message"></div>
        </form>
      </div>
    </div>

    <footer role="contentinfo">
      <small>Prototype MAMA+ ‚Äì Am√©lioration du suivi pr√©natal</small>
    </footer>

    <!-- Syst√®me d'authentification -->
    <script src="utils/auth.js"></script>
    <script>
      // Prot√©ger la page - v√©rifier la connexion
      if (!window.protectPage || !window.protectPage('professionnel')) {
        // Redirection en cours
      }
    </script>
    <!-- Syst√®me de lecture audio -->
    <script src="utils/audio-helper.js"></script>
    <!-- Syst√®me d'ic√¥nes -->
    <script src="utils/icons.js"></script>
    <!-- Liste des centres de sant√© de C√¥te d'Ivoire -->
    <script src="utils/health-centers-ci.js"></script>
    <!-- G√©n√©rateur de CPN -->
    <script src="utils/cpn-generator.js"></script>
    <script>
      // Logique pour l'aper√ßu des CPN en temps r√©el
      document.addEventListener('DOMContentLoaded', function() {
        const premiereCPNInput = document.querySelector("#patiente-premiere-cpn");
        const semaineGrossesseInput = document.querySelector("#patiente-semaine-grossesse");
        const nombreCPNSelect = document.querySelector("#patiente-nombre-cpn");
        const cpnPreview = document.querySelector("#cpn-preview");
        const cpnPreviewList = document.querySelector("#cpn-preview-list");

        function updateCPNPreview() {
          if (!premiereCPNInput || !semaineGrossesseInput || !nombreCPNSelect || !cpnPreview || !cpnPreviewList) {
            return;
          }

          const datePremiereCPN = premiereCPNInput.value;
          const semaineGrossesse = parseInt(semaineGrossesseInput.value) || null;
          const nombreCPN = parseInt(nombreCPNSelect.value) || 4;

          if (datePremiereCPN && semaineGrossesse && window.generateCPNCalendar && window.formatCPNPreview) {
            const cpnList = window.generateCPNCalendar(datePremiereCPN, semaineGrossesse, nombreCPN);
            if (cpnList && cpnList.length > 0) {
              cpnPreviewList.innerHTML = window.formatCPNPreview(cpnList);
              cpnPreview.style.display = "block";
            } else {
              cpnPreview.style.display = "none";
            }
          } else {
            cpnPreview.style.display = "none";
          }
        }

        if (premiereCPNInput) {
          premiereCPNInput.addEventListener('change', updateCPNPreview);
          premiereCPNInput.addEventListener('input', updateCPNPreview);
        }
        if (semaineGrossesseInput) {
          semaineGrossesseInput.addEventListener('change', updateCPNPreview);
          semaineGrossesseInput.addEventListener('input', updateCPNPreview);
        }
        if (nombreCPNSelect) {
          nombreCPNSelect.addEventListener('change', updateCPNPreview);
        }
      });
    </script>
    <script>
      // Initialiser les ic√¥nes au chargement
      document.addEventListener('DOMContentLoaded', function() {
        if (window.getIcon) {
          const backIconLink = document.querySelector('#back-icon-link');
          if (backIconLink) {
            backIconLink.innerHTML = window.getIcon('back', 24, 'white');
          }
          
          const headerPatientesIcon = document.querySelector('#header-patientes-icon');
          if (headerPatientesIcon) {
            headerPatientesIcon.innerHTML = window.getIcon('pregnant-woman', 28, 'white');
          }
        }
      });
    </script>
    <!-- Composants UX -->
    <script src="utils/ux-components.js"></script>
    <!-- Navigation mobile -->
    <script src="utils/mobile-nav.js" defer></script>
    <!-- Version simplifi√©e - Fonctionne sans serveur backend -->
    <script src="app-professionnel-simple.js" defer></script>
    <script>
      // Fonction pour retourner selon le type d'utilisateur
      function goBack() {
        const userType = localStorage.getItem('mama_user_type') || 'professionnel';
        if (userType === 'etablissement') {
          window.location.href = 'index-etablissement.html';
        } else {
          window.location.href = 'index-professionnel.html';
        }
      }
    </script>
    <!-- Version compl√®te avec backend (d√©commenter si vous avez un serveur backend) -->
    <!-- <script src="app-professionnel.js" defer></script> -->
    <script>
      // Event listeners pour le modal de consultation
      document.addEventListener('DOMContentLoaded', function() {
        const consultationForm = document.querySelector("#add-consultation-form");
        const closeConsultationModalBtn = document.querySelector("#close-consultation-modal-btn");
        const cancelConsultationBtn = document.querySelector("#cancel-consultation-btn");
        const consultationModal = document.querySelector("#add-consultation-modal");
        
        if (consultationForm) {
          consultationForm.addEventListener("submit", window.handleConsultationSubmit);
        }
        
        if (closeConsultationModalBtn) {
          closeConsultationModalBtn.addEventListener("click", window.closeConsultationModal);
        }
        
        if (cancelConsultationBtn) {
          cancelConsultationBtn.addEventListener("click", window.closeConsultationModal);
        }
        
        // Fermer le modal en cliquant en dehors
        if (consultationModal) {
          consultationModal.addEventListener("click", (e) => {
            if (e.target === consultationModal) {
              window.closeConsultationModal();
            }
          });
        }
      });
    </script>
  </body>
</html>

